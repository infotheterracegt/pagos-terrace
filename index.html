<script>
  const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyIn5hYqNcybMVJG0677ABowA7SeUhBEM3cutWaaVfd3jVe8EzLLg4sv-qQRGETxml0/exec';

  const POLLING_INTERVAL = 2500;
  const MAX_TIMEOUT = 120000;

  const params = new URLSearchParams(window.location.search);
  const email = params.get('email');

  let intentos = 0;
  let polling = null;
  let timeoutId = null;
  let yaRedirigido = false;
  let ultimoScript = null;

  if (!email) {
    mostrarError('No se detectó un email válido. Por favor, vuelve al formulario.');
  } else {
    polling = setInterval(buscarLink, POLLING_INTERVAL);

    timeoutId = setTimeout(() => {
      clearInterval(polling);
      mostrarError('El proceso tardó demasiado. Por favor, intenta de nuevo.');
    }, MAX_TIMEOUT);
  }

  function buscarLink() {
    if (ultimoScript) {
      document.head.removeChild(ultimoScript);
      ultimoScript = null;
    }

    const script = document.createElement('script');
    ultimoScript = script;

    script.src =
      APPS_SCRIPT_URL +
      '?email=' +
      encodeURIComponent(email) +
      '&callback=handleResponse&_=' +
      Date.now(); // cache buster

    script.onerror = function () {
      intentos++;
      limpiarScript();

      if (intentos >= 5) {
        clearInterval(polling);
        clearTimeout(timeoutId);
        mostrarError('No se pudo conectar con el servidor. Por favor, intenta de nuevo.');
      }
    };

    document.head.appendChild(script);
  }

  window.handleResponse = function (data) {
    limpiarScript();

    if (yaRedirigido) return;

    if (data.status === 'success' && data.link) {
      yaRedirigido = true;
      clearInterval(polling);
      clearTimeout(timeoutId);
      mostrarExito();

      setTimeout(() => {
        window.location.href = data.link;
      }, 1500);
      return;
    }

    if (data.status === 'error') {
      intentos++;
      if (intentos >= 5) {
        clearInterval(polling);
        clearTimeout(timeoutId);
        mostrarError(data.message || 'Error al generar el pago.');
      }
    }
    // status === 'pending' → no hacer nada
  };

  function limpiarScript() {
    if (ultimoScript) {
      document.head.removeChild(ultimoScript);
      ultimoScript = null;
    }
  }

  function mostrarExito() {
    document.getElementById('loading').style.display = 'none';
    document.getElementById('success').style.display = 'block';
  }

  function mostrarError(mensaje) {
    document.getElementById('loading').style.display = 'none';
    document.getElementById('errorMessage').textContent = mensaje;
    document.getElementById('error').style.display = 'block';
  }
</script>
